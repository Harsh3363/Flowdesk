{"version":3,"file":"tambo-v1-stream-context.js","sourceRoot":"","sources":["../../../src/v1/providers/tambo-v1-stream-context.tsx"],"names":[],"mappings":";AAAA,YAAY,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuJb,sDAkDC;AAsBD,wCAQC;AA0BD,8CAUC;AA0BD,kDAUC;AA7SD;;;;;;GAMG;AAEH,6EAA6E;AAC7E,6DAA6D;AAC7D,+CAQe;AACf,kEAKoC;AAiCpC;;;GAGG;AACH,MAAM,kBAAkB,GAAG,IAAA,qBAAa,EAAqB,IAAI,CAAC,CAAC;AAEnE;;;GAGG;AACH,MAAM,qBAAqB,GAAG,IAAA,qBAAa,EACzC,IAAI,CACL,CAAC;AAEF;;;GAGG;AACH,MAAM,uBAAuB,GAAG,IAAA,qBAAa,EAA0B,IAAI,CAAC,CAAC;AAqB7E;;;;GAIG;AACH,SAAS,kBAAkB,CAAC,KAAiC;IAC3D,MAAM,EAAE,aAAa,EAAE,QAAQ,EAAE,GAAG,KAAK,CAAC;IAE1C,kCAAkC;IAClC,MAAM,SAAS,GAGX,EAAE,CAAC;IAEP,kDAAkD;IAClD,IAAI,QAAQ,EAAE,CAAC;QACb,0CAA0C;QAC1C,MAAM,SAAS,GAAG,IAAA,4CAAwB,EAAC,QAAQ,CAAC,CAAC;QAErD,sDAAsD;QACtD,MAAM,WAAW,GAAG,aAAa;YAC/B,CAAC,CAAC;gBACE,GAAG,SAAS;gBACZ,MAAM,EAAE;oBACN,GAAG,SAAS,CAAC,MAAM;oBACnB,GAAG,aAAa;oBAChB,EAAE,EAAE,QAAQ,EAAE,mCAAmC;iBAClD;aACF;YACH,CAAC,CAAC,SAAS,CAAC;QAEd,SAAS,CAAC,QAAQ,CAAC,GAAG,WAAW,CAAC;IACpC,CAAC;IAED,OAAO;QACL,SAAS;QACT,eAAe,EAAE,QAAQ,IAAI,IAAI;KAClC,CAAC;AACJ,CAAC;AAED;;;;;;;;;;;;GAYG;AACH,SAAgB,qBAAqB,CAAC,KAAiC;IACrE,MAAM,EAAE,QAAQ,EAAE,GAAG,KAAK,CAAC;IAE3B,MAAM,YAAY,GAAG,IAAA,eAAO,EAC1B,GAAG,EAAE,CAAC,kBAAkB,CAAC,KAAK,CAAC;IAC/B,qCAAqC;IACrC,uDAAuD;IACvD,CAAC,KAAK,CAAC,QAAQ,CAAC,CACjB,CAAC;IAEF,MAAM,CAAC,KAAK,EAAE,QAAQ,CAAC,GAAG,IAAA,kBAAU,EAAC,iCAAa,EAAE,YAAY,CAAC,CAAC;IAElE,8BAA8B;IAC9B,MAAM,UAAU,GAAG,IAAA,mBAAW,EAC5B,CAAC,QAAgB,EAAE,aAAsC,EAAE,EAAE;QAC3D,QAAQ,CAAC,EAAE,IAAI,EAAE,aAAa,EAAE,QAAQ,EAAE,aAAa,EAAE,CAAC,CAAC;IAC7D,CAAC,EACD,EAAE,CACH,CAAC;IAEF,MAAM,YAAY,GAAG,IAAA,mBAAW,EAAC,CAAC,QAAuB,EAAE,EAAE;QAC3D,QAAQ,CAAC,EAAE,IAAI,EAAE,oBAAoB,EAAE,QAAQ,EAAE,CAAC,CAAC;IACrD,CAAC,EAAE,EAAE,CAAC,CAAC;IAEP,MAAM,cAAc,GAAG,IAAA,mBAAW,EAAC,GAAG,EAAE;QACtC,MAAM,MAAM,GAAG,QAAQ,MAAM,CAAC,UAAU,EAAE,EAAE,CAAC;QAC7C,gEAAgE;QAChE,+DAA+D;QAC/D,QAAQ,CAAC,EAAE,IAAI,EAAE,kBAAkB,EAAE,QAAQ,EAAE,MAAM,EAAE,CAAC,CAAC;QACzD,OAAO,MAAM,CAAC;IAChB,CAAC,EAAE,EAAE,CAAC,CAAC;IAEP,MAAM,gBAAgB,GAAG,IAAA,eAAO,EAC9B,GAAG,EAAE,CAAC,CAAC;QACL,UAAU;QACV,YAAY;QACZ,cAAc;KACf,CAAC,EACF,CAAC,UAAU,EAAE,YAAY,EAAE,cAAc,CAAC,CAC3C,CAAC;IAEF,OAAO,CACL,8BAAC,kBAAkB,CAAC,QAAQ,IAAC,KAAK,EAAE,KAAK;QACvC,8BAAC,qBAAqB,CAAC,QAAQ,IAAC,KAAK,EAAE,QAAQ;YAC7C,8BAAC,uBAAuB,CAAC,QAAQ,IAAC,KAAK,EAAE,gBAAgB,IACtD,QAAQ,CACwB,CACJ,CACL,CAC/B,CAAC;AACJ,CAAC;AAED;;;;;;;;;;;;;;;;;;;GAmBG;AACH,SAAgB,cAAc;IAC5B,MAAM,OAAO,GAAG,IAAA,kBAAU,EAAC,kBAAkB,CAAC,CAAC;IAE/C,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,KAAK,CAAC,0DAA0D,CAAC,CAAC;IAC9E,CAAC;IAED,OAAO,OAAO,CAAC;AACjB,CAAC;AAED;;;;;;;;;;;;;;;;;;;;;;;GAuBG;AACH,SAAgB,iBAAiB;IAC/B,MAAM,OAAO,GAAG,IAAA,kBAAU,EAAC,qBAAqB,CAAC,CAAC;IAElD,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,KAAK,CACb,6DAA6D,CAC9D,CAAC;IACJ,CAAC;IAED,OAAO,OAAO,CAAC;AACjB,CAAC;AAED;;;;;;;;;;;;;;;;;;;;;;;GAuBG;AACH,SAAgB,mBAAmB;IACjC,MAAM,OAAO,GAAG,IAAA,kBAAU,EAAC,uBAAuB,CAAC,CAAC;IAEpD,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,KAAK,CACb,+DAA+D,CAChE,CAAC;IACJ,CAAC;IAED,OAAO,OAAO,CAAC;AACjB,CAAC","sourcesContent":["\"use client\";\n\n/**\n * Stream Context Provider for v1 API\n *\n * Manages streaming state using React Context and useReducer.\n * Provides state and dispatch to child components via separate contexts\n * following the split-context pattern for optimal re-render performance.\n */\n\n// React is used implicitly for JSX transformation (jsx: \"react\" in tsconfig)\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport React, {\n  createContext,\n  useReducer,\n  useContext,\n  useMemo,\n  useCallback,\n  type ReactNode,\n  type Dispatch,\n} from \"react\";\nimport {\n  streamReducer,\n  createInitialThreadState,\n  type StreamState,\n  type StreamAction,\n} from \"../utils/event-accumulator\";\nimport type { TamboV1Thread } from \"../types/thread\";\n\n/**\n * Thread management functions exposed by the stream context.\n */\nexport interface ThreadManagement {\n  /**\n   * Initialize a new thread in the stream context.\n   * Use this before sending messages to a new thread.\n   * @param threadId - The thread ID to initialize\n   * @param initialThread - Optional initial thread data\n   */\n  initThread: (\n    threadId: string,\n    initialThread?: Partial<TamboV1Thread>,\n  ) => void;\n\n  /**\n   * Switch the current active thread.\n   * Does not fetch thread data - use useTamboV1Thread for that.\n   * @param threadId - The thread ID to switch to, or null to clear\n   */\n  switchThread: (threadId: string | null) => void;\n\n  /**\n   * Start a new thread (generates a temporary ID).\n   * The actual thread ID will be assigned when the first message is sent.\n   * @returns The temporary thread ID\n   */\n  startNewThread: () => string;\n}\n\n/**\n * Context for accessing stream state (read-only).\n * Separated from dispatch context to prevent unnecessary re-renders.\n */\nconst StreamStateContext = createContext<StreamState | null>(null);\n\n/**\n * Context for dispatching events to the stream reducer.\n * Separated from state context to prevent unnecessary re-renders.\n */\nconst StreamDispatchContext = createContext<Dispatch<StreamAction> | null>(\n  null,\n);\n\n/**\n * Context for thread management functions.\n * Separated from state to prevent unnecessary re-renders.\n */\nconst ThreadManagementContext = createContext<ThreadManagement | null>(null);\n\n/**\n * Props for TamboV1StreamProvider\n */\nexport interface TamboV1StreamProviderProps {\n  children: ReactNode;\n\n  /**\n   * Initial thread state (optional).\n   * If not provided, an empty thread will be created.\n   */\n  initialThread?: Partial<TamboV1Thread>;\n\n  /**\n   * Thread ID for the stream context.\n   * Used to initialize the thread if initialThread is not provided.\n   */\n  threadId?: string;\n}\n\n/**\n * Creates initial stream state from props.\n * @param props - Provider props\n * @returns Initial stream state\n */\nfunction createInitialState(props: TamboV1StreamProviderProps): StreamState {\n  const { initialThread, threadId } = props;\n\n  // Initialize with empty threadMap\n  const threadMap: Record<\n    string,\n    ReturnType<typeof createInitialThreadState>\n  > = {};\n\n  // If threadId is provided, initialize that thread\n  if (threadId) {\n    // Create initial thread state (immutably)\n    const baseState = createInitialThreadState(threadId);\n\n    // If initial thread data provided, merge it immutably\n    const threadState = initialThread\n      ? {\n          ...baseState,\n          thread: {\n            ...baseState.thread,\n            ...initialThread,\n            id: threadId, // Always use the provided threadId\n          },\n        }\n      : baseState;\n\n    threadMap[threadId] = threadState;\n  }\n\n  return {\n    threadMap,\n    currentThreadId: threadId ?? null,\n  };\n}\n\n/**\n * Provider component for stream state management.\n *\n * Uses useReducer with streamReducer to accumulate AG-UI events into\n * thread state. Provides state, dispatch, and thread management via separate contexts.\n * @returns JSX element wrapping children with stream contexts\n * @example\n * ```tsx\n * <TamboV1StreamProvider threadId=\"thread_123\">\n *   <ChatInterface />\n * </TamboV1StreamProvider>\n * ```\n */\nexport function TamboV1StreamProvider(props: TamboV1StreamProviderProps) {\n  const { children } = props;\n\n  const initialState = useMemo(\n    () => createInitialState(props),\n    // Only recompute if threadId changes\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [props.threadId],\n  );\n\n  const [state, dispatch] = useReducer(streamReducer, initialState);\n\n  // Thread management functions\n  const initThread = useCallback(\n    (threadId: string, initialThread?: Partial<TamboV1Thread>) => {\n      dispatch({ type: \"INIT_THREAD\", threadId, initialThread });\n    },\n    [],\n  );\n\n  const switchThread = useCallback((threadId: string | null) => {\n    dispatch({ type: \"SET_CURRENT_THREAD\", threadId });\n  }, []);\n\n  const startNewThread = useCallback(() => {\n    const tempId = `temp_${crypto.randomUUID()}`;\n    // Use atomic START_NEW_THREAD action to prevent race conditions\n    // when multiple calls happen concurrently (e.g., double-click)\n    dispatch({ type: \"START_NEW_THREAD\", threadId: tempId });\n    return tempId;\n  }, []);\n\n  const threadManagement = useMemo<ThreadManagement>(\n    () => ({\n      initThread,\n      switchThread,\n      startNewThread,\n    }),\n    [initThread, switchThread, startNewThread],\n  );\n\n  return (\n    <StreamStateContext.Provider value={state}>\n      <StreamDispatchContext.Provider value={dispatch}>\n        <ThreadManagementContext.Provider value={threadManagement}>\n          {children}\n        </ThreadManagementContext.Provider>\n      </StreamDispatchContext.Provider>\n    </StreamStateContext.Provider>\n  );\n}\n\n/**\n * Hook to access stream state.\n *\n * Must be used within TamboV1StreamProvider.\n * @returns Current stream state\n * @throws {Error} if used outside TamboV1StreamProvider\n * @example\n * ```tsx\n * function ChatMessages() {\n *   const { thread, streaming } = useStreamState();\n *\n *   return (\n *     <div>\n *       {thread.messages.map(msg => <Message key={msg.id} message={msg} />)}\n *       {streaming.status === 'streaming' && <LoadingIndicator />}\n *     </div>\n *   );\n * }\n * ```\n */\nexport function useStreamState(): StreamState {\n  const context = useContext(StreamStateContext);\n\n  if (!context) {\n    throw new Error(\"useStreamState must be used within TamboV1StreamProvider\");\n  }\n\n  return context;\n}\n\n/**\n * Hook to access stream dispatch function.\n *\n * Must be used within TamboV1StreamProvider.\n * @returns Dispatch function for sending events to reducer\n * @throws {Error} if used outside TamboV1StreamProvider\n * @example\n * ```tsx\n * function StreamHandler() {\n *   const dispatch = useStreamDispatch();\n *\n *   useEffect(() => {\n *     async function handleStream() {\n *       for await (const event of streamEvents) {\n *         dispatch({ type: 'EVENT', event });\n *       }\n *     }\n *     handleStream();\n *   }, [dispatch]);\n *\n *   return null;\n * }\n * ```\n */\nexport function useStreamDispatch(): Dispatch<StreamAction> {\n  const context = useContext(StreamDispatchContext);\n\n  if (!context) {\n    throw new Error(\n      \"useStreamDispatch must be used within TamboV1StreamProvider\",\n    );\n  }\n\n  return context;\n}\n\n/**\n * Hook to access thread management functions.\n *\n * Must be used within TamboV1StreamProvider.\n * @returns Thread management functions\n * @throws {Error} if used outside TamboV1StreamProvider\n * @example\n * ```tsx\n * function ThreadSwitcher() {\n *   const { switchThread, startNewThread } = useThreadManagement();\n *\n *   return (\n *     <div>\n *       <button onClick={() => switchThread('thread_123')}>\n *         Load Thread\n *       </button>\n *       <button onClick={startNewThread}>\n *         New Chat\n *       </button>\n *     </div>\n *   );\n * }\n * ```\n */\nexport function useThreadManagement(): ThreadManagement {\n  const context = useContext(ThreadManagementContext);\n\n  if (!context) {\n    throw new Error(\n      \"useThreadManagement must be used within TamboV1StreamProvider\",\n    );\n  }\n\n  return context;\n}\n"]}